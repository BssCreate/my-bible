<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    .panel {
      flex: 1;
      padding: 1rem;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    .panel:last-child {
      border-right: none;
    }

    h2 {
      margin-top: 0;
    }

    .item {
      background-color: rgb(238, 238, 238);
      padding: 0.5rem;
      margin-bottom: 0.3rem;
      border-radius: 6px;
      cursor: pointer;
      color: #000;
    }

    .item:hover {
      background: #f0f0f0;
    }

    .item.active {
      background: #cce5ff;
    }

    .placeholder {
      color: #999;
      text-align: center;
    }

    .bottom-buttons {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
    }

    .bottom-buttons-stud {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap; /* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏—Å—å */
    }

    .bottom-buttons-stud button {
      display: inline-block;
      margin: 0 0.5rem;
    }

    button {
      background-color: #e7e7e7; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–µ—Ä—ã–µ */
      color: #000;
      border: none;
      padding: 10px 16px;
      margin: 5px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button[style*="background:green"] {
      background-color: #4CAF50 !important;
      color: white;
    }

    button[style*="background:red"] {
      background-color: #f44336 !important;
      color: white;
    }

    button:hover {
      opacity: 0.9;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      background-color: #eee !important;
      color: #888;
      cursor: not-allowed;
    }

    #studentItems.grid-students {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    #studentItems .placeholder-text {
      grid-column: 1 / -1; /* –ß—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞–ª–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */
      text-align: center;
      color: gray;
    }


    #classItems {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 –∫–æ–ª–æ–Ω–∫–∏ */
      gap: 8px;
    }

    .class-button {
      padding: 8px 12px;
      color: #000;
      background: #eee;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
    }

    .class-button:hover {
      background: #ddd;
    }

    .class-button.selected,
    .class-button.active {
      background-color: #ade1ff;
      color: rgb(0, 0, 0);
    }

    #classList {
      position: relative;
      flex: 0.6;
      padding-bottom: 70px; /* —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤ */
      text-align: center;   /* –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    }

    .bottom-buttons {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap; /* –∫–Ω–æ–ø–∫–∏ –≤ —Å—Ç—Ä–æ–∫—É */
    }

    .bottom-buttons button {
      display: inline-block;
      margin: 0 0.5rem;
    }

    #studentDetails p {
      text-align: left;
    }

    #studentList {
      position: relative;
      padding-bottom: 70px; /* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç */
      text-align: center;   /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-row label {
      width: 130px;
      font-size: 14px;
      color: #333;
    }

    .modal-input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .modal-input:focus {
      border-color: #007bff;
      outline: none;
    }

    .modal-btn {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #ccc;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-btn:hover {
      background: #bbb;
    }

    .modal-btn.primary {
      background: #007bff;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #005dc0;
    }




  </style>
</head>
<body>
  <div class="panel" id="classList">
    <h2>–ö–ª–∞—Å—Å—ã</h2>
    <div id="classItems" class="placeholder">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="bottom-buttons">
      <button onclick="openAddClassModal()">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</button>
      <button onclick="deleteCurrentClass()" style="background:red">–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å</button>
    </div>
    
  </div>

  <div class="panel" id="studentList">
    <h2>–£—á–µ–Ω–∏–∫–∏</h2>
    <div id="studentItems" class="grid-students">
      <div class="placeholder-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤</div>
    </div>  
      <div class="bottom-buttons-stud">
        <button onclick="openAddStudentModal()">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
        <button onclick="openDeleteStudentModal()">–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
      </div>
  </div>
  

  <div class="panel" id="studentInfo">
    <h2 style="text-align: center">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <div id="studentDetails" class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>
  
    <div id="studentInfoButtons" style="display:none; margin-top: 15px; text-align: center;">
      <button onclick="openEditStudentModal()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button onclick="openBooksModal()">–ö–Ω–∏–≥–∏</button>
      <button onclick="clearStudentInfo()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:300px;">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</h3>
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label><br>
      <select id="gradeSelect">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="11">–£—á–∏—Ç–µ–ª—è</option>
      </select><br><br>

      <label>–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–≤—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label><br>
      <select id="letterSelect">
        <option value="">(–±–µ–∑ –±—É–∫–≤—ã)</option>
        <option value="–ê">–ê</option>
        <option value="–ë">–ë</option>
        <option value="–í">–í</option>
        <option value="–ì">–ì</option>
        <option value="–î">–î</option>
      </select><br><br>

      <button onclick="addClass()" style="background:green">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button onclick="closeAddClassModal()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
  <div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:320px; text-align:center;">
      <p id="deleteText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å?</p>
      <button onclick="confirmDeleteClass()" style="margin-right: 10px;">–î–∞</button>
      <button onclick="closeDeleteModal()">–ù–µ—Ç</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
  <div id="deleteStudentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:320px; text-align:center;">
      <p id="deleteStudentText">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞?</p>
      <button onclick="confirmDeleteStudent()" style="margin-right: 10px;">–î–∞</button>
      <button onclick="closeDeleteStudentModal()">–ù–µ—Ç</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ö–Ω–∏–≥–∏ -->
  <div id="booksModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center; z-index:1200;">
    <div style="
      background:white;
      padding:24px;
      border-radius:12px;
      width:700px;
      max-height:90vh;
      overflow:auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    ">
      <h2 style="margin-top: 0; text-align: center; color: #333;">–ö–Ω–∏–≥–∏ —É—á–µ–Ω–∏–∫–∞</h2>

      <table id="booksTable" border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%; margin-bottom: 15px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th>–£–¥–∞–ª–∏—Ç—å</th>
            <th>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
            <th>–ò–Ω–≤. –ù–æ–º–µ—Ä</th>
            <th>–û—Ç–¥–µ–ª</th>
            <th>–ê–≤—Ç–æ—Ä –∏ –∑–∞–≥–ª–∞–≤–∏–µ –∫–Ω–∏–≥–∏</th>
            <th>–í–µ—Ä–Ω—É—Ç–∞</th>
          </tr>
        </thead>
        <tbody>
          <!-- –ö–Ω–∏–≥–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
      </table>

      <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="openAddBookRow()" class="modal-btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeBooksModal()" class="modal-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>



  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
  <div id="addStudentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center; z-index:1000;">
    <div style="
      background:white;
      padding:24px;
      border-radius:12px;
      width:450px;
      max-height:90vh;
      overflow:auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-family: sans-serif;
    ">
      <h2 style="margin-top: 0; text-align: center; color: #333;">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h2>

      <div style="display: grid; gap: 10px;">

        <div class="input-row"><label>–ù–æ–º–µ—Ä</label><input type="text" id="studentNumber" name="–ù–æ–º–µ—Ä" class="modal-input"></div>
        <div class="input-row"><label>–ì–æ–¥</label><input type="text" id="studentYear" name="–ì–æ–¥" class="modal-input"></div>
        <div class="input-row"><label>–§–∞–º–∏–ª–∏—è</label><input type="text" id="studentLastName" name="–§–∞–º–∏–ª–∏—è" class="modal-input"></div>
        <div class="input-row"><label>–ò–º—è</label><input type="text" id="studentFirstName" name="–ò–º—è" class="modal-input"></div>
        <div class="input-row"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input type="text" id="studentMiddleName" name="–û—Ç—á–µ—Å—Ç–≤–æ" class="modal-input"></div>
        <div class="input-row"><label>–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="date" id="studentBirthYear" name="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" class="modal-input"></div>
        <div class="input-row"><label>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</label><input type="text" id="studentEducation" name="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" class="modal-input"></div>
        <div class="input-row"><label>–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å</label><input type="text" id="studentAddress" name="–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å" class="modal-input"></div>
        <div class="input-row"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="studentPhone" name="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" value="+7" class="modal-input"></div>
        <div class="input-row"><label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label><input type="date" id="studentRegDate" name="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" class="modal-input"></div>

      </div>

      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button onclick="submitStudent()" class="modal-btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeAddStudentModal()" class="modal-btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞ -->
  <div id="editStudentModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; justify-content:center; align-items:center; z-index:1100;">
    <div style="
      background:white;
      padding:24px;
      border-radius:12px;
      width:450px;
      max-height:90vh;
      overflow:auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-family: sans-serif;
    ">
      <h2 style="margin-top: 0; text-align: center; color: #333;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–µ–Ω–∏–∫–∞</h2>

      <div style="display: grid; gap: 10px;">

        <div class="input-row"><label>–ù–æ–º–µ—Ä</label><input type="text" id="editStudentNumber" name="–ù–æ–º–µ—Ä" class="modal-input"></div>
        <div class="input-row"><label>–ì–æ–¥</label><input type="text" id="editStudentYear" name="–ì–æ–¥" class="modal-input"></div>
        <div class="input-row"><label>–§–∞–º–∏–ª–∏—è</label><input type="text" id="editStudentLastName" name="–§–∞–º–∏–ª–∏—è" class="modal-input"></div>
        <div class="input-row"><label>–ò–º—è</label><input type="text" id="editStudentFirstName" name="–ò–º—è" class="modal-input"></div>
        <div class="input-row"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input type="text" id="editStudentMiddleName" name="–û—Ç—á–µ—Å—Ç–≤–æ" class="modal-input"></div>
        <div class="input-row"><label>–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input type="date" id="editStudentBirthYear" name="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" class="modal-input"></div>
        <div class="input-row"><label>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</label><input type="text" id="editStudentEducation" name="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" class="modal-input"></div>
        <div class="input-row"><label>–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å</label><input type="text" id="editStudentAddress" name="–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å" class="modal-input"></div>
        <div class="input-row"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="editStudentPhone" name="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="modal-input"></div>
        <div class="input-row"><label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label><input type="date" id="editStudentRegDate" name="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" class="modal-input"></div>

      </div>

      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button onclick="submitEditStudent()" class="modal-btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="closeEditStudentModal()" class="modal-btn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>





  <script>
    const firebaseConfig = {
      databaseURL: "https://my-library-d430a-default-rtdb.europe-west1.firebasedatabase.app/",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥");
      location.href = "auth.html";
    }
  
    const classItems = document.getElementById("classItems");
    const studentItems = document.getElementById("studentItems");
    const studentDetails = document.getElementById("studentDetails");
  
    let classes = {}; // –∫–ª–∞—Å—Å—ã –∏–∑ –±–∞–∑—ã
    let currentClass = null;
    let currentStudent = null;
  
    document.addEventListener("DOMContentLoaded", () => {
      loadClassesFromDatabase();
    });
  
    function loadClassesFromDatabase() {
      const schoolName = localStorage.getItem("school");
      if (!schoolName) {
        alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage");
        location.href = "auth.html";
        return;
      }
  
      firebase.database().ref("list1").once("value")
        .then(snapshot => {
          const schools = snapshot.val();
          let schoolId = null;
  
          for (const [id, data] of Object.entries(schools)) {
            if (data.school === schoolName) {
              schoolId = id;
              break;
            }
          }
  
          if (!schoolId) {
            alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ");
            return;
          }
  
          const studentsJsonPath = `list1/${schoolId}/students_json`;
          return firebase.database().ref(studentsJsonPath).once("value");
        })
        .then(jsonSnap => {
          if (!jsonSnap) return;
  
          const jsonStr = jsonSnap.val();
          try {
            classes = jsonStr ? JSON.parse(jsonStr) : {};
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON:", e);
            classes = {};
          }
  
          renderClassList();
        })
        .catch(error => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–æ–≤:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–æ–≤");
        });
    }
  
    function renderClassList() {
    const sortedClassNames = Object.keys(classes).sort(sortClasses);
    classItems.innerHTML = "";

    if (sortedClassNames.length === 0) {
      classItems.innerHTML = '<div class="placeholder">–î–æ–±–∞–≤—å—Ç–µ –∫–ª–∞—Å—Å</div>';
    } else {
      sortedClassNames.forEach(className => {
        const div = document.createElement("div");
        div.textContent = className;
        div.className = "class-button";

        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∫–ª–∞—Å—Å, —Å—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ–º
        if (className === currentClass) {
          div.classList.add("selected");
        }

        div.onclick = () => {
          // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫
          document.querySelectorAll("#classItems .class-button").forEach(btn => {
            btn.classList.remove("selected", "active"); // —É–±–∏—Ä–∞–µ–º –æ–±–∞
          });

          // –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫ —Ç–µ–∫—É—â–µ–π
          div.classList.add("selected", "active");

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–ª–∞—Å—Å
          currentClass = className;

          // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤
          selectClass(className, div);
        };

        classItems.appendChild(div);
      });
    }

    studentItems.innerHTML = '<div class="placeholder-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤</div>';
    studentDetails.innerHTML = '<div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>';
  }


  function deleteSelectedStudent() {
    if (!currentClass || !currentStudent) {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞");
      return;
    }

    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞
    alert(`–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ ${currentStudent}?`);
  }


    let currentStudents = []; // —É—á–µ–Ω–∏–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∞—Å—Å–∞

    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∞—Å—Å–∞
    function showClassDetails(className, students) {
      currentClass = className;
      currentStudents = students;
      // –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –µ—Å—Ç—å
    }

    function deleteCurrentClass() {
      if (!currentClass) {
        alert("–ö–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω");
        return;
      }

      const studentCount = currentStudents.length;
      const ending = getStudentEnding(studentCount);
      const text = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <b>${currentClass}</b> —Å ${studentCount} —É—á–µ–Ω–∏–∫${ending}?`;
      document.getElementById("deleteText").innerHTML = text;
      document.getElementById("deleteModal").style.display = "flex";
    }

    function closeDeleteModal() {
      document.getElementById("deleteModal").style.display = "none";
    }

    function confirmDeleteClass() {
      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      if (!schoolName) {
        alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage");
        return;
      }

      firebase.database().ref("list1").once("value")
        .then(snapshot => {
          const schools = snapshot.val();
          let schoolId = null;

          for (const [id, data] of Object.entries(schools)) {
            if (data.school === schoolName) {
              schoolId = id;
              break;
            }
          }

          if (!schoolId) {
            alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ");
            return;
          }

          const studentsJsonPath = `list1/${schoolId}/students_json`;

          return firebase.database().ref(studentsJsonPath).once("value").then(jsonSnap => {
            let json = {};
            try {
              json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
            } catch (e) {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON:", e);
            }

            if (!json[currentClass]) {
              alert("–ö–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
              return;
            }

            delete json[currentClass];

            return firebase.database().ref(studentsJsonPath).set(JSON.stringify(json));
          });
        })
        .then(() => {
          closeDeleteModal();
          currentClass = null;
          currentStudents = [];
          loadClassesFromDatabase(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞:", err);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞");
        });
    }

    function openAddClassModal() {
      document.getElementById("modalOverlay").style.display = "flex";
    }
    function closeAddClassModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    function openEditStudentModal() {
      if (!currentStudent) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
        return;
      }

      document.getElementById("editStudentNumber").value = currentStudent.number || "";
      document.getElementById("editStudentYear").value = currentStudent.year || "";
      document.getElementById("editStudentLastName").value = currentStudent.lastName || "";
      document.getElementById("editStudentFirstName").value = currentStudent.firstName || "";
      document.getElementById("editStudentMiddleName").value = currentStudent.middleName || "";
      document.getElementById("editStudentBirthYear").value = currentStudent.birthYear || "";
      document.getElementById("editStudentEducation").value = currentStudent.education || "";
      document.getElementById("editStudentAddress").value = currentStudent.address || "";
      document.getElementById("editStudentPhone").value = currentStudent.phone || "";
      document.getElementById("editStudentRegDate").value = currentStudent.regDate || "";

      document.getElementById("editStudentModal").style.display = "flex";
    }

    function closeEditStudentModal() {
      document.getElementById("editStudentModal").style.display = "none";
    }



    function getStudentEnding(count) {
      if (count % 10 === 1 && count % 100 !== 11) return "";
      if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return "–∞";
      return "–æ–≤";
    }

  
    function sortClasses(a, b) {
      if (a === "–£—á–∏—Ç–µ–ª—è") return 1;
      if (b === "–£—á–∏—Ç–µ–ª—è") return -1;

      const regex = /^(\d+)([–ê-–Ø–∞-—è]*)$/;
      const [, numA = "0", strA = ""] = a.match(regex) || [];
      const [, numB = "0", strB = ""] = b.match(regex) || [];

      const diff = parseInt(numA) - parseInt(numB);
      return diff !== 0 ? diff : strA.localeCompare(strB, 'ru');
    }


  
    let currentClassElement = null; // –≥–ª–æ–±–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –±–µ–∑ —Å–±—Ä–æ—Å–∞

    function selectClass(className, element) {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏
      if (!element) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
      document.querySelectorAll('#classItems .item').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      document.getElementById("studentInfoButtons").style.display = "none";
      currentClassElement = element;

      currentClass = className;
      currentStudent = null;

      const studentsList = classes[className] || [];

      if (!studentsList.length) {
        studentItems.innerHTML = '<div class="placeholder-text">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ</div>';
      } else {
        // –û—á–∏—â–∞–µ–º
        studentItems.innerHTML = "";

        // ‚úÖ 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
        studentsList.sort((a, b) => (a["–§–∞–º–∏–ª–∏—è"] || "").localeCompare(b["–§–∞–º–∏–ª–∏—è"] || ""));

        studentsList.forEach((student, index) => {
          const div = document.createElement("div");

          // ‚úÖ 4. –§–∞–º–∏–ª–∏—è –ø–µ—Ä–µ–¥ –∏–º–µ–Ω–µ–º
          const name = `${student.–§–∞–º–∏–ª–∏—è || ""} ${student.–ò–º—è || ""}`.trim() || `–ë–µ–∑ –∏–º–µ–Ω–∏ (${index})`;

          div.textContent = name;
          div.className = "class-button";
          div.style.margin = "4px"; // ‚úÖ 5. –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —É—á–µ–Ω–∏–∫–∞–º–∏

          div.onclick = () => {
            // ‚úÖ 7. –£–±–∏—Ä–∞–µ–º –ø—Ä–æ—à–ª–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            document.querySelectorAll(".class-button.active").forEach(el => el.classList.remove("active"));
            div.classList.add("active");

            selectStudent({ 
              id: `${className}_${index}`,
              class: className,
              number: student["–ù–æ–º–µ—Ä"] || "‚Äî",
              year: student["–ì–æ–¥"] || "‚Äî",
              lastName: student["–§–∞–º–∏–ª–∏—è"] || "‚Äî",
              firstName: student["–ò–º—è"] || "‚Äî",
              middleName: student["–û—Ç—á–µ—Å—Ç–≤–æ"] || "‚Äî",
              birthYear: student["–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è"] || "‚Äî",
              education: student["–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"] || "‚Äî",
              address: student["–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å"] || "‚Äî",
              phone: student["–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"] || "‚Äî",
              regDate: student["–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"] || "‚Äî",
              password: student["–ü–∞—Ä–æ–ª—å"] || "‚Äî"
            }, div);
          };

          studentItems.appendChild(div);
        });
      }

      studentDetails.innerHTML = '<div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>';
    }

    function formatDateToDDMMYYYY(dateStr) {
      if (!dateStr || typeof dateStr !== "string") return dateStr;
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        const [yyyy, mm, dd] = dateStr.split("-");
        return `${dd}.${mm}.${yyyy}`;
      }
      return dateStr; // —É–∂–µ –≤ –Ω—É–∂–Ω–æ–º –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    }

    function selectStudent(student, element) {
      // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö
      document.querySelectorAll('#studentItems .item').forEach(el => el.classList.remove('active'));

      // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
      if (element) {
        element.classList.add('active');
      } else {
        console.warn("–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ selectStudent");
      }

      currentStudent = student;

      const formattedRegDate = formatDateToDDMMYYYY(student.regDate);
      const formattedBirthYear = formatDateToDDMMYYYY(student.birthYear);

      studentDetails.innerHTML = `
        <p><strong>–ù–æ–º–µ—Ä:</strong> ${student.number || "‚Äî"}</p>
        <p><strong>–ì–æ–¥:</strong> ${student.year || "‚Äî"}</p>
        <p><strong>–§–∞–º–∏–ª–∏—è:</strong> ${student.lastName || "‚Äî"}</p>
        <p><strong>–ò–º—è, –û—Ç—á–µ—Å—Ç–≤–æ:</strong> ${student.firstName || "‚Äî"}, ${student.middleName || "‚Äî"}</p>
        <p><strong>–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> ${formattedBirthYear || "‚Äî"}</p>
        <p><strong>–ö–ª–∞—Å—Å:</strong> ${student.class || "‚Äî"}</p>
        <p><strong>–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å, —Ç–µ–ª–µ—Ñ–æ–Ω:</strong> ${student.address || "‚Äî"}, ${student.phone || "‚Äî"}</p>
        <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${formattedRegDate || "‚Äî"}</p>
        <p>
          <strong>–ü–∞—Ä–æ–ª—å:</strong> 
          <span id="passwordText" data-password="${student.password || '‚Äî'}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          <button id="togglePassword" style="margin-left:10px;">üëÅÔ∏è</button>
        </p>
      `;

      // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–∞—Ä–æ–ª—è
      const toggleBtn = document.getElementById("togglePassword");
      toggleBtn.addEventListener("click", () => {
        const pwdEl = document.getElementById("passwordText");
        const currentText = pwdEl.textContent;
        if (currentText === "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢") {
          pwdEl.textContent = pwdEl.dataset.password;
        } else {
          pwdEl.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        }
      });

      document.getElementById("studentInfoButtons").style.display = "block";
    }



    function clearStudentInfo() {
      studentDetails.innerHTML = '<div class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>';
      document.getElementById("studentInfoButtons").style.display = "none";
      currentStudent = null;

      // –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–æ–≤
      document.querySelectorAll("#studentItems .class-button.active").forEach(el => el.classList.remove("active"));
    }
  
    function openAddStudentModal() {
      document.getElementById("addStudentModal").style.display = "flex";
    }
    function closeAddStudentModal() {
      document.getElementById("addStudentModal").style.display = "none";
    }

    function saveNewStudent() {
      const inputs = Array.from(document.querySelectorAll("#addStudentModal input"));
      const student = {};

      inputs.forEach(input => {
        let value = input.value.trim();

        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ —Ç–∏–ø–∞ date ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –¥–¥.–º–º.–≥–≥–≥–≥
        if (input.type === "date" && value) {
          const [yyyy, mm, dd] = value.split("-");
          value = `${dd}.${mm}.${yyyy}`;
        }

        student[input.name] = value;
      });

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
      student["–ü–∞—Ä–æ–ª—å"] = generatePassword(getAllExistingPasswords());

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –∫–Ω–∏–≥
      student["books"] = [];

      if (!currentClass) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —É—á–µ–Ω–∏–∫–∞");
        return;
      }

      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      if (!schoolName) {
        alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        return;
      }

      firebase.database().ref("list1").once("value").then(snapshot => {
        const schools = snapshot.val();
        let schoolId = null;

        for (const [id, data] of Object.entries(schools)) {
          if (data.school === schoolName) {
            schoolId = id;
            break;
          }
        }

        if (!schoolId) {
          alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ");
          return;
        }

        const studentsJsonPath = `list1/${schoolId}/students_json`;

        return firebase.database().ref(studentsJsonPath).once("value").then(jsonSnap => {
          let json = {};
          try {
            json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e);
          }

          if (!json[currentClass]) {
            json[currentClass] = [];
          }

          json[currentClass].push(student);

          return firebase.database().ref(studentsJsonPath).set(JSON.stringify(json));
        });
      })
      .then(() => {
        closeAddStudentModal();
        loadClassesFromDatabase(); // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –∏ —É—á–µ–Ω–∏–∫–æ–≤
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞");
      });
    }



    function openDeleteStudentModal() {
      if (!currentStudent || !currentClass) return;

      const fullName = `${currentStudent.lastName || ''} ${currentStudent.firstName || ''}`.trim();
      const className = currentClass || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∞—Å—Å";

      const deleteTextEl = document.getElementById("deleteStudentText");
      deleteTextEl.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ ${fullName} –∏–∑ –∫–ª–∞—Å—Å–∞ ${className}?`;

      document.getElementById("deleteStudentModal").style.display = "flex";
    }

    function closeSaveStudentModal() {
      document.getElementById("editStudentModal").style.display = "none";
    }


    function closeDeleteStudentModal() {
      document.getElementById("deleteStudentModal").style.display = "none";
    }

    function reloadAndSelectClass() {
      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      firebase.database().ref("list1").once("value").then(snapshot => {
        const schools = snapshot.val();
        let schoolId = null;

        for (const [id, data] of Object.entries(schools)) {
          if (data.school === schoolName) {
            schoolId = id;
            break;
          }
        }

        if (!schoolId) throw new Error("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const path = `list1/${schoolId}/students_json`;
        return firebase.database().ref(path).once("value").then(jsonSnap => {
          const json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
          classes = json;

          // üü® –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∞—Å—Å–∞
          const allClassItems = document.querySelectorAll('#classItems .item');
          const found = Array.from(allClassItems).find(el => el.textContent.trim() === currentClass);

          if (found) {
            selectClass(currentClass, found);
          } else {
            console.warn("–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∞—Å—Å–∞:", currentClass);
            // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ—Ç—Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞
            selectClass(currentClass, { classList: { add: () => {} } });
          }
        });
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤:", err);
      });
    }

    function submitEditStudent() {
      const editedStudent = {
        "–ù–æ–º–µ—Ä": document.getElementById("editStudentNumber").value.trim(),
        "–ì–æ–¥": document.getElementById("editStudentYear").value.trim(),
        "–§–∞–º–∏–ª–∏—è": document.getElementById("editStudentLastName").value.trim(),
        "–ò–º—è": document.getElementById("editStudentFirstName").value.trim(),
        "–û—Ç—á–µ—Å—Ç–≤–æ": document.getElementById("editStudentMiddleName").value.trim(),
        "–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è": document.getElementById("editStudentBirthYear").value.trim(),
        "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": document.getElementById("editStudentEducation").value.trim(),
        "–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å": document.getElementById("editStudentAddress").value.trim(),
        "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞": document.getElementById("editStudentPhone").value.trim(),
        "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏": document.getElementById("editStudentRegDate").value.trim(),
        // –ù–ï –±–µ—Ä–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ —Ñ–æ—Ä–º—ã, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –º–µ–Ω—è–ª—Å—è
      };

      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      firebase.database().ref("list1").once("value").then(snapshot => {
        const schools = snapshot.val();
        let schoolId = null;

        for (const [id, data] of Object.entries(schools)) {
          if (data.school === schoolName) {
            schoolId = id;
            break;
          }
        }

        if (!schoolId) throw new Error("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const path = `list1/${schoolId}/students_json`;

        return firebase.database().ref(path).once("value").then(jsonSnap => {
          let json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
          if (!json[currentClass]) {
            console.warn("–ö–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ json:", currentClass);
            return;
          }

          const indexToUpdate = parseInt(currentStudent.id.split("_")[1]);
          if (!json[currentClass][indexToUpdate]) {
            console.warn("–£—á–µ–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–Ω–¥–µ–∫—Å–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
            return;
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          json[currentClass][indexToUpdate] = { 
            ...json[currentClass][indexToUpdate],  // —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            ...editedStudent,                      // –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            "–ü–∞—Ä–æ–ª—å": json[currentClass][indexToUpdate]["–ü–∞—Ä–æ–ª—å"]  // –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          };

          return firebase.database().ref(path).set(JSON.stringify(json)).then(() => {
            console.log("–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");

            reloadAndSelectClass();

            setTimeout(() => {
              const updatedStudent = {
                id: `${currentClass}_${indexToUpdate}`,
                class: currentClass,
                number: editedStudent["–ù–æ–º–µ—Ä"] || "‚Äî",
                year: editedStudent["–ì–æ–¥"] || "‚Äî",
                lastName: editedStudent["–§–∞–º–∏–ª–∏—è"] || "‚Äî",
                firstName: editedStudent["–ò–º—è"] || "‚Äî",
                middleName: editedStudent["–û—Ç—á–µ—Å—Ç–≤–æ"] || "‚Äî",
                birthYear: editedStudent["–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è"] || "‚Äî",
                education: editedStudent["–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"] || "‚Äî",
                address: editedStudent["–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å"] || "‚Äî",
                phone: editedStudent["–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"] || "‚Äî",
                regDate: editedStudent["–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"] || "‚Äî",
                password: json[currentClass][indexToUpdate]["–ü–∞—Ä–æ–ª—å"] || "‚Äî"  // –ø–∞—Ä–æ–ª—å –±–µ—Ä—ë–º –∏–∑ –±–∞–∑—ã
              };

              const studentElements = document.querySelectorAll("#studentItems .class-button");
              const studentDiv = Array.from(studentElements).find(div =>
                div.textContent.includes(editedStudent["–§–∞–º–∏–ª–∏—è"])
              );

              currentStudent = updatedStudent;
              if (typeof selectStudent === "function") {
                selectStudent(updatedStudent, studentDiv || null);
              }
            }, 300);

            closeEditStudentModal();
            if (typeof closeSaveStudentModal === "function") {
              closeSaveStudentModal();
            }
          });
        });
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
        if (typeof closeSaveStudentModal === "function") {
          closeSaveStudentModal();
          currentStudent = editedStudent; // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ —É—á–µ–Ω–∏–∫–∞
          showStudentDetails(editedStudent); // –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          loadClassesFromDatabase();
        }
      });
    }






    function confirmDeleteStudent() {
      if (!currentClass || !currentStudent) return;

      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      firebase.database().ref("list1").once("value").then(snapshot => {
        const schools = snapshot.val();
        let schoolId = null;

        for (const [id, data] of Object.entries(schools)) {
          if (data.school === schoolName) {
            schoolId = id;
            break;
          }
        }

        if (!schoolId) throw new Error("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const path = `list1/${schoolId}/students_json`;

        return firebase.database().ref(path).once("value").then(jsonSnap => {
          let json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
          if (!json[currentClass]) return;

          const indexToRemove = parseInt(currentStudent.id.split("_")[1]);
          const updated = json[currentClass].filter((_, i) => i !== indexToRemove);
          json[currentClass] = updated;

          return firebase.database().ref(path).set(JSON.stringify(json)).then(() => ({
            schoolId,
            updatedJson: json
          }));
        });
      })
      .then(({ schoolId, updatedJson }) => {
        closeDeleteStudentModal();
        currentStudent = null;
        reloadAndSelectClass();
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞");
      });
    }






    function generatePassword(existingPasswords) {
      const words = [
        '–∫–æ—Ç', '–º–∏—Ä', '–ª–µ—Å', '–¥–æ–º', '–∑–µ–±—Ä–∞', '—Å–æ–≤–∞', '–ª—É–Ω–∞', '—Ä—ã–±–∞', '—è–≥–æ–¥–∞', '–Ω–æ—Å–æ–∫',
        '—Ç—Ä–∞–≤–∞', '–ø—Ç–∏—Ü–∞', '–≤–∏–ª–∫–∞', '–ª–∞–º–ø–∞', '–∫–∞—à–∞', '–º—ã–ª–æ', '–∫—É—Å—Ç', '–ø–µ—á—å', '–≥—Ä—É—à–∞',
        '–æ–≤—Ä–∞–≥', '–ø–∞–Ω–¥–∞', '–ø–∞—Ä—É—Å', '–∫—Ä—ã—à–∞', '–ø–µ—Ä–µ—Ü', '—á–∞—à–∫–∞', '–∫–∞–ø–ª—è', '—Å–∞–ø–æ–≥', '–ø–æ—á–∫–∞',
        '–ø–µ—Å–æ–∫', '–≤–æ–¥–∞', '–ø–µ—á–∫–∞', '–ø–ª–æ–¥', '–∫–∏—Å—Ç—å', '–ª–∏—Å—Ç', '–∑–µ–º–ª—è', '–∫–æ—Å—Ç—å', '—Ö–≤–æ—Å—Ç',
        '–æ–±–ª–∞–∫–æ', '–±–æ—á–∫–∞', '–º–æ—Ä–æ–∑', '–≤–µ—Ç–∫–∞', '–∏–≥–ª–∞', '–æ–∑–µ—Ä–æ', '–∫–Ω–∏–≥–∞', '–º—ã—à—å', '—Ç–µ—Å—Ç–æ',
        '–ª–æ–ø–∞—Ç–∞', '–∫–æ—Ä–∫–∞', '–±–∞–Ω–∞–Ω', '–≤–∏—à–Ω—è', '–ø—É–ª—è', '–ø–µ—Å–Ω—è', '–ø–∞–ª–∫–∞', '–∫–∞–º–µ–Ω—å', '—Å–≤–µ—á–∞',
        '–∫—Ä–æ—Ö–∞', '–ø–∞—á–∫–∞'
      ];
      const forbidden = new Set(["1488", "0069", "6969", "6900", "0690"]);

      let password;
      do {
        const word = words[Math.floor(Math.random() * words.length)];
        const digits = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
        if (forbidden.has(digits)) continue;
        password = word + digits;
      } while (existingPasswords.includes(password));

      return password;
    }

    function getAllExistingPasswords() {
      const passwords = [];
      for (const cls of Object.values(classes)) {
        for (const student of cls) {
          if (student["–ü–∞—Ä–æ–ª—å"]) passwords.push(student["–ü–∞—Ä–æ–ª—å"]);
        }
      }
      return passwords;
    }



    function submitStudent() {
      const ids = [
        "studentNumber", "studentYear", "studentLastName", "studentFirstName",
        "studentMiddleName", "studentBirthYear", "studentEducation",
        "studentAddress", "studentPhone", "studentRegDate"
      ];

      for (const id of ids) {
        const el = document.getElementById(id);
        if (!el) {
          console.error(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç —Å id="${id}"`);
        }
      }

      const newStudent = {
        number: document.getElementById("studentNumber").value.trim(),
        year: document.getElementById("studentYear").value.trim(),
        lastName: document.getElementById("studentLastName").value.trim(),
        firstName: document.getElementById("studentFirstName").value.trim(),
        middleName: document.getElementById("studentMiddleName").value.trim(),
        birthYear: document.getElementById("studentBirthYear").value.trim(),
        education: document.getElementById("studentEducation").value.trim(),
        address: document.getElementById("studentAddress").value.trim(),
        phone: document.getElementById("studentPhone").value.trim(),
        regDate: document.getElementById("studentRegDate").value.trim(),
        password: generatePassword([])
      };

      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      firebase.database().ref("list1").once("value").then(snapshot => {
        const schools = snapshot.val();
        let schoolId = null;

        for (const [id, data] of Object.entries(schools)) {
          if (data.school === schoolName) {
            schoolId = id;
            break;
          }
        }

        if (!schoolId) throw new Error("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        const path = `list1/${schoolId}/students_json`;

        return firebase.database().ref(path).once("value").then(jsonSnap => {
          let json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
          if (!json[currentClass]) json[currentClass] = [];

          json[currentClass].push({
            "–ù–æ–º–µ—Ä": newStudent.number,
            "–ì–æ–¥": newStudent.year,
            "–§–∞–º–∏–ª–∏—è": newStudent.lastName,
            "–ò–º—è": newStudent.firstName,
            "–û—Ç—á–µ—Å—Ç–≤–æ": newStudent.middleName,
            "–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è": newStudent.birthYear,
            "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": newStudent.education,
            "–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å": newStudent.address,
            "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞": newStudent.phone,
            "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏": newStudent.regDate,
            "–ü–∞—Ä–æ–ª—å": newStudent.password
          });

          return firebase.database().ref(path).set(JSON.stringify(json)).then(() => ({
            schoolId,
            updatedJson: json
          }));
        });
      })
      .then(({ schoolId, updatedJson }) => {
        document.querySelectorAll('#addStudentModal input').forEach(i => i.value = "");
        closeAddStudentModal();
        currentStudent = null;
        reloadAndSelectClass();
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞");
      });
    }



    function clearStudentForm() {
      const fields = [
        "studentNumber", "studentYear", "studentLastName", "studentFirstName",
        "studentMiddleName", "studentBirthYear", "studentEducation",
        "studentAddress", "studentPhone", "studentRegDate"
      ];
      fields.forEach(id => document.getElementById(id).value = "");
    }

    function addClass() {
      const gradeEl = document.getElementById("gradeSelect");
      const letterEl = document.getElementById("letterSelect");

      if (!gradeEl || !letterEl) {
        alert("–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        return;
      }

      const grade = gradeEl.value;
      const letter = letterEl.value;

      let newClassName;

      if (grade === "11") {
        newClassName = "–£—á–∏—Ç–µ–ª—è";
      } else {
        newClassName = grade + (letter ? letter : "");
      }

      if (!newClassName) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞");
        return;
      }

      const user = JSON.parse(localStorage.getItem("user"));
      const schoolName = user?.school;

      if (!schoolName) {
        alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage");
        return;
      }

      firebase.database().ref("list1").once("value")
        .then(snapshot => {
          const schools = snapshot.val();
          let schoolId = null;

          for (const [id, data] of Object.entries(schools)) {
            if (data.school === schoolName) {
              schoolId = id;
              break;
            }
          }

          if (!schoolId) {
            alert("–®–∫–æ–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ");
            return;
          }

          const studentsJsonPath = `list1/${schoolId}/students_json`;

          return firebase.database().ref(studentsJsonPath).once("value").then(jsonSnap => {
            let json = {};
            try {
              json = jsonSnap.exists() ? JSON.parse(jsonSnap.val()) : {};
            } catch (e) {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON:", e);
            }

            if (json[newClassName]) {
              alert("–ö–ª–∞—Å—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
              return;
            }

            json[newClassName] = [];

            return firebase.database().ref(studentsJsonPath).set(JSON.stringify(json));
          });
        })
        .then(() => {
          closeAddClassModal();
          loadClassesFromDatabase();
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞:", err);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞");
        });
    }





  </script>
  
</body>
</html>
